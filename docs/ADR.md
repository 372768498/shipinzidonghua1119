# 🏛️ 架构决策记录 (Architecture Decision Records)

> **文档目的**: 记录Jilo.ai项目的关键架构决策、原因和影响  
> **创建日期**: 2024-11-19  
> **状态**: 持续更新

---

## 📋 目录

1. [什么是ADR](#什么是adr)
2. [决策记录](#决策记录)
   - [ADR-001: 选择"Fire & Forget"异步架构](#adr-001-选择fire--forget异步架构)
   - [ADR-002: 选择Google Gemini而非Claude API](#adr-002-选择google-gemini而非claude-api)
   - [ADR-003: 通过FAL.AI统一接入多模型](#adr-003-通过falai统一接入多模型)
   - [ADR-004: Webhook回调机制设计](#adr-004-webhook回调机制设计)
   - [ADR-005: 原子化配额管理方案](#adr-005-原子化配额管理方案)

---

## 什么是ADR

**Architecture Decision Record (架构决策记录)** 是一种轻量级的文档格式，用于记录在软件项目中做出的重要架构决策。

### 为什么需要ADR？

✅ **记忆外部化**: 6个月后你会忘记为什么这样设计  
✅ **新人友好**: 帮助新加入的开发者快速理解系统  
✅ **避免重复讨论**: 已经讨论过的问题不需要再讨论  
✅ **技术债务管理**: 清楚记录哪些是临时方案，哪些是长期设计

### ADR格式

每个ADR包含：
- **标题**: 简短描述决策
- **状态**: 提议/已接受/已废弃
- **背景**: 为什么需要做这个决策
- **决策**: 我们选择了什么
- **原因**: 为什么这样选择
- **后果**: 这个决策带来的影响（好的和坏的）
- **替代方案**: 我们考虑过但放弃的其他选项

---

## 决策记录

### ADR-001: 选择"Fire & Forget"异步架构

**状态**: ✅ 已接受  
**决策日期**: 2024-11-19  
**决策者**: 项目团队

#### 背景 (Context)

Jilo.ai需要处理两类长时间运行的任务：
1. **视频生成**: 3-10分钟（取决于模型和视频长度）
2. **爬虫任务**: 2-5分钟（取决于平台和数据量）

而我们的部署平台Vercel有严格的超时限制：
- **Hobby Plan**: 10秒
- **Pro Plan**: 60秒
- **Enterprise Plan**: 最长5分钟

这意味着任何超过60秒的任务都会被强制中断，导致用户体验极差。

#### 决策 (Decision)

我们选择了 **"Fire & Forget"异步架构**：

```
用户请求
   ↓
Next.js API (立即返回) 
   ↓
触发外部服务 (FAL.AI/Apify)
   ↓
Webhook回调 ← 外部服务完成任务
   ↓
Supabase Realtime → 前端实时更新
```

**核心原则**:
- API路由只负责"触发"任务，不等待任务完成
- 立即返回任务ID给用户（响应时间<500ms）
- 外部服务完成后通过Webhook通知我们
- 前端通过Supabase Realtime订阅任务状态

#### 原因 (Rationale)

**为什么不用Supabase Edge Functions?**

最初考虑使用Supabase Edge Functions来处理长任务，但有以下问题：

❌ **超时限制**: Edge Functions最长也只有150秒  
❌ **环境割裂**: Node.js项目 + Deno环境，需要维护两套代码  
❌ **调试困难**: Edge Functions的调试体验不如Next.js API  
❌ **成本更高**: Edge Functions按执行时间计费，长任务成本高

**为什么选择"Fire & Forget"?**

✅ **绕过超时限制**: API只负责触发，瞬间返回  
✅ **统一技术栈**: 全部使用Node.js/Next.js，无需Deno  
✅ **更好的用户体验**: 实时进度反馈，不会页面卡死  
✅ **成本可控**: 只为实际计算付费，不为等待付费  
✅ **易于扩展**: 可以轻松对接多个外部服务

#### 后果 (Consequences)

**正面影响** ✅:
- 突破了Vercel的超时限制
- 用户体验大幅提升（不会等待超时）
- 系统更易于扩展和维护
- 技术栈统一，降低团队学习成本

**负面影响** ⚠️:
- 需要实现Webhook安全验证（增加了复杂度）
- 需要处理Webhook失败重试机制
- 前端需要实现实时状态订阅（增加了前端复杂度）
- 需要防止"僵尸任务"（任务卡在processing状态）

**缓解措施**:
- 实现了完整的Webhook签名验证机制
- 添加了任务超时自动标记为失败
- 使用Supabase Realtime简化前端实时更新
- 实现了定时清理僵尸任务的Cron Job

#### 替代方案 (Alternatives)

**方案A: 使用Supabase Edge Functions**
- ❌ 拒绝原因: 超时限制依然存在，环境割裂

**方案B: 轮询机制**
- ❌ 拒绝原因: 浪费资源，用户体验差，增加API调用成本

**方案C: 自建后端服务器**
- ❌ 拒绝原因: 成本高，需要维护服务器，失去Serverless优势

---

### ADR-002: 选择Google Gemini而非Claude API

**状态**: ✅ 已接受  
**决策日期**: 2024-11-19  
**决策者**: 项目团队

#### 背景 (Context)

Jilo.ai需要AI来完成以下任务：
1. **爆款视频分析**: 分析视频为什么火，提取关键要素
2. **内容审查**: 检测生成的视频是否包含违规内容
3. **SEO优化**: 生成YouTube标题、描述、标签
4. **趋势分析**: 分析热门话题和标签

这些任务每天需要调用数千次，成本是关键考虑因素。

#### 决策 (Decision)

我们选择 **Google Gemini 1.5 Flash** 作为主力AI模型。

**具体配置**:
```javascript
// 使用Gemini 1.5 Flash
model: "gemini-1.5-flash"
// 对于复杂分析任务，升级到Gemini 1.5 Pro
model: "gemini-1.5-pro"
```

#### 原因 (Rationale)

**成本对比** (以100万tokens为例):

| 模型 | 输入成本 | 输出成本 | 总成本估算 |
|------|----------|----------|------------|
| **Claude 3.5 Sonnet** | $3.00 | $15.00 | ~$18.00 |
| **Gemini 1.5 Flash** | $0.075 | $0.30 | ~$0.375 |
| **Gemini 1.5 Pro** | $1.25 | $5.00 | ~$6.25 |

**成本差距**: Gemini Flash比Claude便宜 **40倍** 🔥

**为什么Gemini足够用?**

✅ **性能足够**: 对于我们的用例，Gemini 1.5 Flash完全够用  
✅ **速度更快**: 响应速度比Claude快30-50%  
✅ **大上下文**: 支持100万tokens上下文（适合长视频分析）  
✅ **多模态**: 原生支持图片+视频输入  
✅ **免费额度**: 每天有免费额度可以用于开发测试

**实际使用策略**:
- **常规任务**: 使用Gemini 1.5 Flash（成本极低）
- **复杂任务**: 升级到Gemini 1.5 Pro（依然比Claude便宜3倍）
- **特殊场景**: 保留Claude API作为备选（如需要更强推理能力）

#### 后果 (Consequences)

**正面影响** ✅:
- **成本降低40倍**: 从每月$10,000降到$250
- **响应更快**: API调用速度提升30-50%
- **更大上下文**: 可以分析更长的视频和文本
- **多模态能力**: 可以直接处理视频帧，不需要先提取文本

**负面影响** ⚠️:
- Gemini的中文能力略弱于Claude（但对英文内容影响不大）
- API稳定性略低于Claude（偶尔会有限流）

**缓解措施**:
- 对于中文内容，使用更详细的Prompt
- 实现多模型备份机制（Gemini失败时降级到Claude）
- 添加重试机制处理偶发性失败

#### 替代方案 (Alternatives)

**方案A: 使用Claude API**
- ❌ 拒绝原因: 成本太高，40倍差价

**方案B: 使用OpenAI GPT-4**
- ❌ 拒绝原因: 成本依然较高，且上下文长度不如Gemini

**方案C: 使用开源模型自部署**
- ❌ 拒绝原因: 需要GPU服务器，运维成本高，性能不稳定

---

## 待补充的ADR

以下决策记录将在后续补充：

- [ ] **ADR-003**: 通过FAL.AI统一接入多模型
- [ ] **ADR-004**: Webhook回调机制设计
- [ ] **ADR-005**: 原子化配额管理方案
- [ ] **ADR-006**: 内容审查三层防护策略
- [ ] **ADR-007**: 数据库RLS策略设计

---

<div align="center">

**文档版本**: V1.0 (部分完成)  
**最后更新**: 2024-11-19  

[返回目录](../README.md) | [下一步: 查看架构文档](./ARCHITECTURE.md)

</div>
